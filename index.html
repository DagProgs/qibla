<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Направление на Каабу с картой</title>
<!-- Подключение Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
  #map { height: 500px; margin: 20px auto; max-width: 600px; }
  #direction {
    width: 200px; height: 200px; margin: 20px auto;
    position: relative; display: flex; align-items: center; justify-content: center;
  }
  #arrow {
    width: 0; height: 0;
    border-left: 20px solid transparent;
    border-right: 20px solid transparent;
    border-bottom: 80px solid crimson;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(0deg);
    transform-origin: bottom center;
    transition: transform 0.5s ease;
  }
  #status { margin-top: 10px; }
</style>
</head>
<body>

<h2>Направление на Каабу</h2>
<div id="map"></div>
<div id="direction">
  <div id="arrow"></div>
</div>
<div id="status">Получение данных...</div>

<!-- Подключение Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // Координаты Каабы (Мекка)
  const kabbaLat = 21.4225;
  const kabbaLon = 39.8262;

  let userMarker = null;
  let map = null;
  let userLat = null;
  let userLon = null;
  let currentBearing = 0;

  // Инициализация карты
  function initMap(lat, lon) {
    map = L.map('map').setView([lat, lon], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    userMarker = L.marker([lat, lon]).addTo(map).bindPopup("Ваше местоположение").openPopup();
  }

  // Получение геолокации
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      position => {
        userLat = position.coords.latitude;
        userLon = position.coords.longitude;
        document.getElementById('status').innerText = 'Координаты получены. Старт карты.';
        initMap(userLat, userLon);
        updateDirection();
      },
      error => {
        document.getElementById('status').innerText = 'Ошибка получения геолокации: ' + error.message;
      }
    );
  } else {
    document.getElementById('status').innerText = 'Геолокация не поддерживается в браузере.';
  }

  // Обработка ориентации
  if (window.DeviceOrientationEvent) {
    window.addEventListener('deviceorientation', handleOrientation);
  } else {
    document.getElementById('status').innerText = 'Ориентация устройства не поддерживается.';
  }

  // Обработка ориентации устройства
  function handleOrientation(event) {
    if (event.alpha !== null) {
      // alpha — направление устройства относительно магнитного севера
      // В градусах
      let deviceHeading = event.alpha;

      if (userLat !== null && userLon !== null) {
        // Вычисляем азимут к Каабе
        const bearing = getBearing(userLat, userLon, kabbaLat, kabbaLon);
        // Учитываем направление устройства
        currentBearing = bearing - deviceHeading;
        updateArrow(currentBearing);
      }
    }
  }

  // Вычисление азимута
  function getBearing(lat1, lon1, lat2, lon2) {
    const φ1 = lat1 * Math.PI/180;
    const φ2 = lat2 * Math.PI/180;
    const Δλ = (lon2 - lon1) * Math.PI/180;
    const y = Math.sin(Δλ) * Math.cos(φ2);
    const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
    let θ = Math.atan2(y, x);
    θ = θ * 180/Math.PI;
    return (θ + 360) % 360;
  }

  // Обновление стрелки
  function updateArrow(angle) {
    const arrow = document.getElementById('arrow');
    arrow.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`;
  }
</script>
</body>
</html>